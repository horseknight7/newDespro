<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Kompos Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./style.css" />
</head>

<body>
    <div class="app-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Kompos<br>Dashboard</h1>
                <div class="session-info">
                    <span class="badge-label">Session</span>
                    <span id="session-id" class="badge-value">session_001</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">
                    <h3>Control</h3>
                    <span id="sessionStatus" class="status-pill status-stopped">Stopped</span>
                </div>
                <div class="control-grid">
                    <button id="btnStart" class="btn-primary">Start</button>
                    <button id="btnStop" class="btn-secondary" disabled>Stop</button>
                    <button id="btnDummy" class="btn-ghost">Dummy Data</button>
                    <button id="btnDummyImage" class="btn-ghost">Dummy Cam</button>
                    <input type="file" id="camFile" accept="image/*" style="display:none" />
                    <button id="btnUploadTestImage" class="btn-ghost">Upload Img</button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Thresholds</h3>
                <div class="threshold-form">
                    <div class="form-group">
                        <label>Temp (¬∞C)</label>
                        <div class="row">
                            <input id="thTempMin" type="number" placeholder="Min" />
                            <input id="thTempMax" type="number" placeholder="Max" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Moist (%)</label>
                        <div class="row">
                            <input id="thMoistMin" type="number" placeholder="Min" />
                            <input id="thMoistMax" type="number" placeholder="Max" />
                        </div>
                    </div>
                    <button id="btnSaveThreshold" class="btn-small">Save Settings</button>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- TOP BAR: SENSORS -->
            <header class="top-bar" id="currentCard">
                <div class="sensor-list">
                    <div class="sensor-pill temp">
                        <span class="icon">üå°Ô∏è</span>
                        <span class="value" id="temp">-</span>
                        <span class="unit">¬∞C</span>
                    </div>
                    <div class="sensor-pill moist">
                        <span class="icon">üíß</span>
                        <span class="value" id="moist">-</span>
                        <span class="unit">%</span>
                    </div>
                    <div class="sensor-pill">
                        <span class="label">Gas</span>
                        <span class="value" id="gas">-</span>
                    </div>
                    <div class="sensor-pill">
                        <span class="label">pH</span>
                        <span class="value" id="ph">-</span>
                    </div>
                    <div class="sensor-pill">
                        <span class="label">EC</span>
                        <span class="value" id="ec">-</span>
                    </div>
                    <div class="sensor-pill">
                        <span class="label">Mat</span>
                        <span class="value" id="maturity">-</span>
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="meta-info">
                    <span id="lastUpdate">Waiting for data...</span>
                </div>
                <!-- Alerts Container -->
                <div id="tempAlert" class="alert-toast" style="display:none"></div>
                <div id="moistAlert" class="alert-toast" style="display:none"></div>
            </header>

            <!-- DASHBOARD GRID -->
            <div class="dashboard-layout">
                <div class="charts-area">
                    <div class="chart-box">
                        <canvas id="tempChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <canvas id="moistChart"></canvas>
                    </div>
                </div>

                <div class="camera-area">
                    <div class="camera-box">
                        <div class="cam-header">
                            <span>Live Feed</span>
                            <span id="imgTimestamp" class="time-badge">-</span>
                        </div>
                        <div class="cam-view">
                            <img id="compostImage" src="" alt="Live" />
                            <div id="imagePlaceholder" class="placeholder">No Signal</div>
                        </div>
                    </div>
                    <div class="history-box">
                        <div class="history-header">
                            <span>History</span>
                            <div class="nav">
                                <button id="imgPrev" disabled>&lt;</button>
                                <span id="imgPageLabel">1/1</span>
                                <button id="imgNext" disabled>&gt;</button>
                            </div>
                        </div>
                        <div id="imageHistory" class="history-thumbs"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase + Logic -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getDatabase,
            ref,
            onValue,
            set,
            update,
            query,
            orderByKey,
            limitToLast,
            get
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        import {
            getStorage,
            ref as storageRef,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";


        // Chart helper
        import {
            createTempChart,
            updateTempChart,
            createMoistChart,
            updateMoistChart
        } from "./tempChart.js";

        // Format number (fix float panjang)
        const fmt = (v, d = 1) => (v == null || isNaN(v) ? "-" : Number(v).toFixed(d));

        const DEFAULT_THRESHOLDS = {
            temp_min: 55,
            temp_max: 65,
            moist_min: 40,
            moist_max: 60,
        };
        // Threshold suhu maksimum (¬∞C)
        const thTempMinEl = document.getElementById("thTempMin");
        const thTempMaxEl = document.getElementById("thTempMax");
        const thMoistMinEl = document.getElementById("thMoistMin");
        const thMoistMaxEl = document.getElementById("thMoistMax");
        const btnSaveThreshold = document.getElementById("btnSaveThreshold");
        const fileInputCam = document.getElementById("camFile");
        const btnUploadTestImage = document.getElementById("btnUploadTestImage");



        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDJ_vVRBcNu9mBHeJY9L42rjH20IlxTLgw",
            authDomain: "compost-box.firebaseapp.com",
            databaseURL: "https://compost-box-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "compost-box",
            storageBucket: "compost-box.firebasestorage.app",
            messagingSenderId: "161024168281",
            appId: "1:161024168281:web:91fb7c6dd22fc7baf97c48",
            measurementId: "G-69FL0VCF5N"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        const SESSION_ID = "session_001";
        document.getElementById("session-id").textContent = SESSION_ID;

        const latestRef = ref(db, `latest/${SESSION_ID}`);
        const logsRef = ref(db, `sensor_logs/${SESSION_ID}`);
        const currentCard = document.getElementById("currentCard");
        const tempAlertEl = document.getElementById("tempAlert");

        const sessionRef = ref(db, `sessions/${SESSION_ID}`);
        const imagesRef = ref(db, `images/${SESSION_ID}`);

        const thresholdRef = ref(db, `sessions/${SESSION_ID}/threshold`);



        const statusEl = document.getElementById("sessionStatus");
        const btnStart = document.getElementById("btnStart");
        const btnStop = document.getElementById("btnStop");
        const btnDummy = document.getElementById("btnDummy");

        const btnDummyImage = document.getElementById("btnDummyImage");
        const imgEl = document.getElementById("compostImage");
        const imgTimeEl = document.getElementById("imgTimestamp");
        const imgPlaceholderEl = document.getElementById("imagePlaceholder");
        const imageHistoryEl = document.getElementById("imageHistory");

        // pagination controls
        const imgPrevBtn = document.getElementById("imgPrev");
        const imgNextBtn = document.getElementById("imgNext");
        const imgPageLabel = document.getElementById("imgPageLabel");

        // state history
        let imageEntries = [];  // array [timestamp, info]
        let imagePage = 0;
        const IMAGE_PAGE_SIZE = 6;


        let currentStatus = "stopped";
        let thresholds = { ...DEFAULT_THRESHOLDS };
        let lastLatest = null;

        // buat chart
        const tempChart = createTempChart(
            document.getElementById("tempChart").getContext("2d")
        );

        const moistChart = createMoistChart(
            document.getElementById("moistChart").getContext("2d")
        );

        // ======= SESSION STATE LISTENER =======
        onValue(sessionRef, async (snap) => {
            let data = snap.val();

            // kalau belum ada dokumen session sama sekali, inisialisasi
            if (!data) {
                const now = Math.floor(Date.now() / 1000);
                data = {
                    status: "stopped",
                    started_at: null,
                    ended_at: now
                };
                await set(sessionRef, data);
            }

            currentStatus = data.status || "stopped";
            updateSessionUI();
        });

        // Ubah bagian threshold initialization
        onValue(thresholdRef, async (snap) => {
            let t = snap.val();

            if (!t) {
                await update(thresholdRef, DEFAULT_THRESHOLDS);
                t = DEFAULT_THRESHOLDS;
            }

            thresholds = { ...DEFAULT_THRESHOLDS, ...t };

            thTempMinEl.value = thresholds.temp_min;
            thTempMaxEl.value = thresholds.temp_max;
            thMoistMinEl.value = thresholds.moist_min;
            thMoistMaxEl.value = thresholds.moist_max;

            applyTempAlert();
            refreshChart();
        });




        function updateSessionUI() {
            statusEl.textContent = currentStatus === "running" ? "Running" : "Stopped";

            statusEl.classList.remove("status-running", "status-stopped");
            statusEl.classList.add(
                currentStatus === "running" ? "status-running" : "status-stopped"
            );

            if (currentStatus === "running") {
                btnStart.disabled = true;
                btnStop.disabled = false;
            } else {
                btnStart.disabled = false;
                btnStop.disabled = true;
            }
        }

        // ======= SENSOR LATEST LISTENER =======

        onValue(latestRef, (snap) => {
            const d = snap.val();
            if (!d) return;

            lastLatest = d; // simpan global

            document.getElementById("temp").textContent = fmt(d.temperature, 1);
            document.getElementById("moist").textContent = fmt(d.moisture, 0);
            document.getElementById("gas").textContent = fmt(d.gas, 0);
            document.getElementById("ph").textContent = fmt(d.ph, 2);
            document.getElementById("ec").textContent = fmt(d.ec, 2);
            document.getElementById("maturity").textContent = fmt(d.maturity, 0);

            if (d.timestamp) {
                document.getElementById("lastUpdate").textContent =
                    new Date(d.timestamp * 1000).toLocaleString();
            }

            applyTempAlert();
            refreshChart();
        });


        function applyTempAlert() {
            if (!lastLatest) return;

            const tempVal = Number(lastLatest.temperature);
            const moistVal = Number(lastLatest.moisture);

            const { temp_min, temp_max, moist_min, moist_max } = thresholds;
            const tempAlertEl = document.getElementById("tempAlert");
            const moistAlertEl = document.getElementById("moistAlert");

            // Temperature alert
            if (!isNaN(tempVal) && (tempVal < temp_min || tempVal > temp_max)) {
                tempAlertEl.textContent =
                    `‚ö†Ô∏è Temperature ${fmt(tempVal, 1)} ¬∞C outside range ` +
                    `${temp_min}‚Äì${temp_max} ¬∞C.`;
                tempAlertEl.style.display = "block";
                tempAlertEl.style.color = "#ff4d4f";
            } else {
                tempAlertEl.style.display = "none";
            }

            // Moisture alert
            if (!isNaN(moistVal) && (moistVal < moist_min || moistVal > moist_max)) {
                moistAlertEl.textContent =
                    `‚ö†Ô∏è Moisture ${fmt(moistVal, 0)}% outside range ` +
                    `${moist_min}‚Äì${moist_max}%.`;
                moistAlertEl.style.display = "block";
                moistAlertEl.style.color = "#ffa940";
            } else {
                moistAlertEl.style.display = "none";
            }

            // Tambah/remove class alert pada card
            if (currentCard) {
                if ((tempAlertEl.style.display === "block") || (moistAlertEl.style.display === "block")) {
                    currentCard.classList.add("card-alert");
                } else {
                    currentCard.classList.remove("card-alert");
                }
            }
        }

        function renderImageHistory() {
            if (!imageHistoryEl) return;

            // Reset grid
            imageHistoryEl.innerHTML = "";

            // Jika tidak ada gambar
            if (!imageEntries || imageEntries.length === 0) {
                for (let i = 0; i < IMAGE_PAGE_SIZE; i++) {
                    const emptyDiv = document.createElement("div");
                    emptyDiv.className = "image-history-item empty";
                    emptyDiv.textContent = "No Image";
                    imageHistoryEl.appendChild(emptyDiv);
                }

                if (imgPageLabel) imgPageLabel.textContent = "Page 0 / 0";
                if (imgPrevBtn) imgPrevBtn.disabled = true;
                if (imgNextBtn) imgNextBtn.disabled = true;
                return;
            }

            // Hitung pagination
            const totalPages = Math.ceil(imageEntries.length / IMAGE_PAGE_SIZE);
            if (totalPages === 0) {
                if (imgPageLabel) imgPageLabel.textContent = "Page 0 / 0";
                if (imgPrevBtn) imgPrevBtn.disabled = true;
                if (imgNextBtn) imgNextBtn.disabled = true;
                return;
            }

            // Pastikan page valid
            if (imagePage >= totalPages) imagePage = totalPages - 1;
            if (imagePage < 0) imagePage = 0;

            const start = imagePage * IMAGE_PAGE_SIZE;
            const end = start + IMAGE_PAGE_SIZE;
            const pageItems = imageEntries.slice(start, end);

            // Render gambar yang ada
            pageItems.forEach(([ts, item]) => {
                if (!item || !item.url) return;

                const t = item.timestamp || ts;
                const timeStr = t
                    ? new Date(t * 1000).toLocaleTimeString([], {
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                    : String(ts);

                const div = document.createElement("div");
                div.className = "image-history-item";

                // Kontainer gambar
                const imgContainer = document.createElement("div");
                imgContainer.className = "image-history-img-container";

                const img = document.createElement("img");
                img.src = item.url;
                img.alt = `Compost ${timeStr}`;
                img.loading = "lazy"; // Optimasi loading

                imgContainer.appendChild(img);

                // Metadata
                const meta = document.createElement("div");
                meta.className = "image-history-meta";
                meta.textContent = timeStr;

                div.appendChild(imgContainer);
                div.appendChild(meta);

                // Klik untuk tampilkan sebagai gambar utama
                div.addEventListener("click", () => {
                    imgEl.src = item.url;
                    imgEl.style.display = "block";
                    imgPlaceholderEl.style.display = "none";
                    if (t) {
                        imgTimeEl.textContent = new Date(t * 1000).toLocaleString();
                    }
                });

                imageHistoryEl.appendChild(div);
            });

            // Tambah placeholder untuk sisa slot yang kosong
            const remainingSlots = IMAGE_PAGE_SIZE - pageItems.length;
            for (let i = 0; i < remainingSlots; i++) {
                const emptyDiv = document.createElement("div");
                emptyDiv.className = "image-history-item empty";
                emptyDiv.textContent = "Empty";
                imageHistoryEl.appendChild(emptyDiv);
            }

            // Update UI pagination
            if (imgPageLabel) {
                imgPageLabel.textContent = `Page ${imagePage + 1} / ${totalPages}`;
            }
            if (imgPrevBtn) imgPrevBtn.disabled = imagePage === 0;
            if (imgNextBtn) imgNextBtn.disabled = imagePage >= totalPages - 1;
        }

        // ======= ESP32-CAM IMAGE LISTENER =======
        onValue(imagesRef, (snap) => {
            const data = snap.val();

            if (!data) {
                imgEl.style.display = "none";
                imgPlaceholderEl.style.display = "block";
                imgTimeEl.textContent = "-";
                if (imageHistoryEl) imageHistoryEl.innerHTML = "";
                return;
            }

            // sort semua entry berdasarkan timestamp (key)
            const entries = Object.entries(data)
                .map(([k, v]) => [Number(k), v])
                .filter(([ts, v]) => v && v.url)
                .sort((a, b) => b[0] - a[0]); // newest-first

            imageEntries = entries;

            // ========== LATEST ==========
            const [latestTs, latestInfo] = entries[0];

            imgEl.src = latestInfo.url;
            imgEl.style.display = "block";
            imgPlaceholderEl.style.display = "none";

            const t = latestInfo.timestamp || latestTs;
            imgTimeEl.textContent = t
                ? new Date(t * 1000).toLocaleString()
                : "-";

            // reset ke halaman pertama tiap ada update baru
            imagePage = 0;
            renderImageHistory();

            // ========== HISTORY (misal 6 terakhir) ==========
            if (imageHistoryEl) {
                const MAX_HISTORY = 6;
                const latestEntries = entries.slice(-MAX_HISTORY).reverse(); // terbaru di depan

                imageHistoryEl.innerHTML = "";

                latestEntries.forEach(([key, item]) => {
                    if (!item || !item.url) return;
                    const t = item.timestamp || Number(key);
                    const timeStr = t
                        ? new Date(t * 1000).toLocaleTimeString()
                        : key;

                    const div = document.createElement("div");
                    div.className = "image-history-item";
                    div.innerHTML = `
        <img src="${item.url}" alt="Compost ${timeStr}" />
        <div class="image-history-meta">
          ${timeStr}
        </div>
      `;

                    // klik thumbnail -> jadikan sebagai gambar utama
                    div.addEventListener("click", () => {
                        imgEl.src = item.url;
                        imgEl.style.display = "block";
                        imgPlaceholderEl.style.display = "none";
                        if (t) {
                            imgTimeEl.textContent = new Date(t * 1000).toLocaleString();
                        }
                    });

                    imageHistoryEl.appendChild(div);
                });
            }
        });

        if (imgPrevBtn) {
            imgPrevBtn.addEventListener("click", () => {
                if (imagePage > 0) {
                    imagePage--;
                    renderImageHistory();
                }
            });
        }

        if (imgNextBtn) {
            imgNextBtn.addEventListener("click", () => {
                const totalPages = Math.ceil(imageEntries.length / IMAGE_PAGE_SIZE);
                if (imagePage < totalPages - 1) {
                    imagePage++;
                    renderImageHistory();
                }
            });
        }





        // ======= BUTTON HANDLERS =======

        // Start session
        btnStart.addEventListener("click", async () => {
            const now = Math.floor(Date.now() / 1000);

            await update(sessionRef, {
                status: "running",
                started_at: now,
                ended_at: null
            });
        });

        btnSaveThreshold.addEventListener("click", async () => {
            const t = {
                temp_min: Number(thTempMinEl.value),
                temp_max: Number(thTempMaxEl.value),
                moist_min: Number(thMoistMinEl.value),
                moist_max: Number(thMoistMaxEl.value)
            };

            await update(thresholdRef, t);
            alert("Threshold updated.");
        });


        // Stop session
        btnStop.addEventListener("click", async () => {
            const now = Math.floor(Date.now() / 1000);

            await update(sessionRef, {
                status: "stopped",
                ended_at: now
            });
        });

        // Generate Dummy Data ‚Äì hanya kalau running
        btnDummy.addEventListener("click", async () => {
            if (currentStatus !== "running") {
                alert("Session belum running. Tekan Start dulu.");
                return;
            }

            const t = Math.floor(Date.now() / 1000);

            const data = {
                timestamp: t,
                temperature: 55 + Math.random() * 15,
                moisture: 40 + Math.round(Math.random() * 20),
                gas: 100 + Math.round(Math.random() * 80),
                ph: 7 + (Math.random() * 0.6 - 0.3),
                ec: 2 + (Math.random() * 0.5 - 0.25),
                maturity: 60 + Math.round(Math.random() * 20)
            };

            await set(ref(db, `sensor_logs/${SESSION_ID}/${t}`), data);
            await set(latestRef, data);
        });



        // Dummy Image ‚Äì simulasi ESP32-CAM (hanya ketika running)
        btnDummyImage.addEventListener("click", async () => {
            if (currentStatus !== "running") {
                alert("Session belum running. Tekan Start dulu.");
                return;
            }

            const t = Math.floor(Date.now() / 1000);
            // Dummy URL pakai picsum (hanya buat testing)
            const url = `https://picsum.photos/seed/${t}/640/360`;

            await set(ref(db, `images/${SESSION_ID}/${t}`), {
                url,
                timestamp: t
            });
        });

        // Klik tombol -> buka file picker
        btnUploadTestImage.addEventListener("click", () => {
            fileInputCam.click();
        });

        // Saat file dipilih -> upload ke Storage + simpan URL ke RTDB
        fileInputCam.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (currentStatus !== "running") {
                alert("Session belum running. Tekan Start dulu.");
                fileInputCam.value = "";
                return;
            }

            try {
                const t = Math.floor(Date.now() / 1000);
                const path = `images/${SESSION_ID}/${t}_${file.name}`;

                // 1) Upload ke Firebase Storage
                const sRef = storageRef(storage, path);
                await uploadBytes(sRef, file);

                // 2) Ambil download URL
                const url = await getDownloadURL(sRef);

                // 3) Tulis metadata ke RTDB
                await set(ref(db, `images/${SESSION_ID}/${t}`), {
                    url,
                    timestamp: t
                });

                fileInputCam.value = "";
                console.log("Uploaded test image:", url);
            } catch (err) {
                console.error("Upload error:", err);
                alert("Gagal upload gambar, lihat console.");
            }
        });



        // ======= CHART REFRESH =======
        // Di bagian script index.html, ubah fungsi refreshChart:
        async function refreshChart() {
            const q = query(logsRef, orderByKey(), limitToLast(20));
            const snap = await get(q);

            const tMin = thresholds.temp_min ?? null;
            const tMax = thresholds.temp_max ?? null;
            const mMin = thresholds.moist_min ?? null;
            const mMax = thresholds.moist_max ?? null;

            if (!snap.exists()) {
                updateTempChart(tempChart, [], [], tMin, tMax);
                updateMoistChart(moistChart, [], [], mMin, mMax);
                return;
            }

            const labels = [];
            const temps = [];
            const moistures = [];

            snap.forEach((child) => {
                const v = child.val();
                labels.push(new Date(child.key * 1000).toLocaleTimeString());
                temps.push(v.temperature);
                moistures.push(v.moisture);
            });

            updateTempChart(tempChart, labels, temps, tMin, tMax);
            updateMoistChart(moistChart, labels, moistures, mMin, mMax);
        }



    </script>
</body>

</html>