<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Kompos Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./style.css" />
</head>

<body>

    <header class="header">
        <div>
            <h1>Kompos Dashboard</h1>
            <p class="subtitle">Monitoring suhu & kelembapan (dummy)</p>
        </div>
        <span class="badge">Session: <span id="session-id">session_001</span></span>
    </header>

    <main class="container">

        <!-- CONTROL PANEL -->
        <section class="card control-card">
            <div class="control-header">
                <h2>Control Panel</h2>
                <p class="status-text">
                    Status:
                    <span id="sessionStatus" class="status-pill status-stopped">
                        Stopped
                    </span>
                </p>
            </div>

            <div class="control-buttons">
                <button id="btnStart" class="btn-primary">Start Session</button>
                <button id="btnStop" class="btn-secondary" disabled>Stop Session</button>
                <button id="btnDummy" class="btn-ghost">Generate Dummy Data</button>
                <button id="btnDummyImage" class="btn-ghost">Dummy Image</button>
            </div>

            <p class="hint">
                Start: ketika proses kompos dimulai. Stop: ketika proses selesai.
                Dummy: simulasi kiriman data dari ESP32 (hanya bekerja saat status Running).
            </p>
        </section>

        <section class="card threshold-card">
            <h2>Threshold Settings</h2>

            <div class="threshold-grid">
                <div>
                    <label>Temperature Min (°C)</label>
                    <input id="thTempMin" type="number" />
                </div>

                <div>
                    <label>Temperature Max (°C)</label>
                    <input id="thTempMax" type="number" />
                </div>

                <div>
                    <label>Moisture Min (%)</label>
                    <input id="thMoistMin" type="number" />
                </div>

                <div>
                    <label>Moisture Max (%)</label>
                    <input id="thMoistMax" type="number" />
                </div>
            </div>

            <button id="btnSaveThreshold" class="btn-primary" style="margin-top:12px;">
                Save Threshold
            </button>
        </section>


        <!-- Card 1: Current Sensors (full width) -->
        <article class="card sensor-card" id="currentCard">
            <h2>Current Sensors</h2>
            <p class="last-update">Last update: <span id="lastUpdate">-</span></p>
            <!-- Di dalam card sensor, tambahkan setelah last-update -->
            <div class="alert-container">
                <p class="alert-message" id="tempAlert">
                    <span class="alert-icon">⚠️</span>
                    <span class="alert-text"></span>
                </p>
                <p class="alert-message" id="moistAlert">
                    <span class="alert-icon">⚠️</span>
                    <span class="alert-text"></span>
                </p>
            </div>
            <!-- Di dalam card sensor, tambahkan alert untuk moisture -->
            <p class="alert-message" id="tempAlert" style="display: none;"></p>
            <p class="alert-message" id="moistAlert" style="display: none;"></p>

            <div class="sensor-grid">
                <div class="sensor-item"><span class="label">Temperature</span><span class="value" id="temp">-</span> °C
                </div>
                <div class="sensor-item"><span class="label">Moisture</span><span class="value" id="moist">-</span>
                    %</div>
                <div class="sensor-item"><span class="label">Gas</span><span class="value" id="gas">-</span></div>
                <div class="sensor-item"><span class="label">pH</span><span class="value" id="ph">-</span></div>
                <div class="sensor-item"><span class="label">EC</span><span class="value" id="ec">-</span> mS/cm
                </div>
                <div class="sensor-item"><span class="label">Maturity</span><span class="value" id="maturity">-</span> %
                </div>
            </div>
        </article>

        <!-- Grid for Charts -->
        <section class="charts-grid">
            <!-- Card 2: Temperature Chart -->
            <article class="card">
                <h2>Temperature Chart (last 20 points)</h2>
                <div class="chart-wrapper">
                    <canvas id="tempChart"></canvas>
                </div>
            </article>

            <!-- Card 3: Moisture Chart -->
            <article class="card">
                <h2>Moisture Chart (last 20 points)</h2>
                <div class="chart-wrapper">
                    <canvas id="moistChart"></canvas>
                </div>
            </article>
        </section>

        <!-- Card 4: ESP32-CAM image -->
        <section class="image-section">
            <article class="card image-card">
                <h2>Compost Camera (latest)</h2>
                <p class="last-update">
                    Last capture: <span id="imgTimestamp">-</span>
                </p>
                <div class="image-frame">
                    <img id="compostImage" src="" alt="Latest compost image" />
                    <p class="image-placeholder" id="imagePlaceholder">
                        No image captured yet.
                    </p>
                </div>
            </article>
        </section>

    </main>

    <!-- Firebase + Logic -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getDatabase,
            ref,
            onValue,
            set,
            update,
            query,
            orderByKey,
            limitToLast,
            get
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        // Chart helper
        import {
            createTempChart,
            updateTempChart,
            createMoistChart,
            updateMoistChart
        } from "./tempChart.js";

        // Format number (fix float panjang)
        const fmt = (v, d = 1) => (v == null || isNaN(v) ? "-" : Number(v).toFixed(d));

        const DEFAULT_THRESHOLDS = {
            temp_min: 55,
            temp_max: 65,
            moist_min: 40,
            moist_max: 60,
        };
        // Threshold suhu maksimum (°C)
        const thTempMinEl = document.getElementById("thTempMin");
        const thTempMaxEl = document.getElementById("thTempMax");
        const thMoistMinEl = document.getElementById("thMoistMin");
        const thMoistMaxEl = document.getElementById("thMoistMax");
        const btnSaveThreshold = document.getElementById("btnSaveThreshold");



        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDQfa1dNCsUD4uGRzt-quIFUwGCstsf03o",
            authDomain: "kompos-dashboard.firebaseapp.com",
            databaseURL: "https://kompos-dashboard-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kompos-dashboard",
            storageBucket: "kompos-dashboard.firebasestorage.app",
            messagingSenderId: "327419558526",
            appId: "1:327419558526:web:45dac1672e4f220a70f62f",
            measurementId: "G-BC874VMNGP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const SESSION_ID = "session_001";
        document.getElementById("session-id").textContent = SESSION_ID;

        const latestRef = ref(db, `latest/${SESSION_ID}`);
        const logsRef = ref(db, `sensor_logs/${SESSION_ID}`);
        const currentCard = document.getElementById("currentCard");
        const tempAlertEl = document.getElementById("tempAlert");

        const sessionRef = ref(db, `sessions/${SESSION_ID}`);
        const imagesRef = ref(db, `images/${SESSION_ID}`);

        const thresholdRef = ref(db, `sessions/${SESSION_ID}/threshold`);



        const statusEl = document.getElementById("sessionStatus");
        const btnStart = document.getElementById("btnStart");
        const btnStop = document.getElementById("btnStop");
        const btnDummy = document.getElementById("btnDummy");

        const btnDummyImage = document.getElementById("btnDummyImage");
        const imgEl = document.getElementById("compostImage");
        const imgTimeEl = document.getElementById("imgTimestamp");
        const imgPlaceholderEl = document.getElementById("imagePlaceholder");


        let currentStatus = "stopped";
        let thresholds = { ...DEFAULT_THRESHOLDS };
        let lastLatest = null;

        // buat chart
        const tempChart = createTempChart(
            document.getElementById("tempChart").getContext("2d")
        );

        const moistChart = createMoistChart(
            document.getElementById("moistChart").getContext("2d")
        );

        // ======= SESSION STATE LISTENER =======
        onValue(sessionRef, async (snap) => {
            let data = snap.val();

            // kalau belum ada dokumen session sama sekali, inisialisasi
            if (!data) {
                const now = Math.floor(Date.now() / 1000);
                data = {
                    status: "stopped",
                    started_at: null,
                    ended_at: now
                };
                await set(sessionRef, data);
            }

            currentStatus = data.status || "stopped";
            updateSessionUI();
        });

        // Ubah bagian threshold initialization
        onValue(thresholdRef, async (snap) => {
            let t = snap.val();

            if (!t) {
                await update(thresholdRef, DEFAULT_THRESHOLDS);
                t = DEFAULT_THRESHOLDS;
            }

            thresholds = { ...DEFAULT_THRESHOLDS, ...t };

            thTempMinEl.value = thresholds.temp_min;
            thTempMaxEl.value = thresholds.temp_max;
            thMoistMinEl.value = thresholds.moist_min;
            thMoistMaxEl.value = thresholds.moist_max;

            applyTempAlert();
            refreshChart();
        });




        function updateSessionUI() {
            statusEl.textContent = currentStatus === "running" ? "Running" : "Stopped";

            statusEl.classList.remove("status-running", "status-stopped");
            statusEl.classList.add(
                currentStatus === "running" ? "status-running" : "status-stopped"
            );

            if (currentStatus === "running") {
                btnStart.disabled = true;
                btnStop.disabled = false;
            } else {
                btnStart.disabled = false;
                btnStop.disabled = true;
            }
        }

        // ======= SENSOR LATEST LISTENER =======

        onValue(latestRef, (snap) => {
            const d = snap.val();
            if (!d) return;

            lastLatest = d; // simpan global

            document.getElementById("temp").textContent = fmt(d.temperature, 1);
            document.getElementById("moist").textContent = fmt(d.moisture, 0);
            document.getElementById("gas").textContent = fmt(d.gas, 0);
            document.getElementById("ph").textContent = fmt(d.ph, 2);
            document.getElementById("ec").textContent = fmt(d.ec, 2);
            document.getElementById("maturity").textContent = fmt(d.maturity, 0);

            if (d.timestamp) {
                document.getElementById("lastUpdate").textContent =
                    new Date(d.timestamp * 1000).toLocaleString();
            }

            applyTempAlert();
            refreshChart();
        });


        function applyTempAlert() {
            if (!lastLatest) return;

            const tempVal = Number(lastLatest.temperature);
            const moistVal = Number(lastLatest.moisture);

            const { temp_min, temp_max, moist_min, moist_max } = thresholds;
            const tempAlertEl = document.getElementById("tempAlert");
            const moistAlertEl = document.getElementById("moistAlert");

            // Temperature alert
            if (!isNaN(tempVal) && (tempVal < temp_min || tempVal > temp_max)) {
                tempAlertEl.textContent =
                    `⚠️ Temperature ${fmt(tempVal, 1)} °C outside range ` +
                    `${temp_min}–${temp_max} °C.`;
                tempAlertEl.style.display = "block";
                tempAlertEl.style.color = "#ff4d4f";
            } else {
                tempAlertEl.style.display = "none";
            }

            // Moisture alert
            if (!isNaN(moistVal) && (moistVal < moist_min || moistVal > moist_max)) {
                moistAlertEl.textContent =
                    `⚠️ Moisture ${fmt(moistVal, 0)}% outside range ` +
                    `${moist_min}–${moist_max}%.`;
                moistAlertEl.style.display = "block";
                moistAlertEl.style.color = "#ffa940";
            } else {
                moistAlertEl.style.display = "none";
            }

            // Tambah/remove class alert pada card
            if (currentCard) {
                if ((tempAlertEl.style.display === "block") || (moistAlertEl.style.display === "block")) {
                    currentCard.classList.add("card-alert");
                } else {
                    currentCard.classList.remove("card-alert");
                }
            }
        }



        // ======= ESP32-CAM IMAGE LISTENER =======
        onValue(imagesRef, (snap) => {
            const data = snap.val();

            if (!data) {
                imgEl.style.display = "none";
                imgPlaceholderEl.style.display = "block";
                imgTimeEl.textContent = "-";
                return;
            }

            // Ambil entry terakhir berdasarkan key timestamp
            const entries = Object.entries(data).sort(
                (a, b) => Number(a[0]) - Number(b[0])
            );
            const [ts, info] = entries[entries.length - 1];

            if (!info || !info.url) {
                imgEl.style.display = "none";
                imgPlaceholderEl.style.display = "block";
                imgTimeEl.textContent = "-";
                return;
            }

            imgEl.src = info.url;
            imgEl.style.display = "block";
            imgPlaceholderEl.style.display = "none";

            const t = info.timestamp || Number(ts);
            if (t) {
                imgTimeEl.textContent = new Date(t * 1000).toLocaleString();
            } else {
                imgTimeEl.textContent = "-";
            }
        });


        // ======= BUTTON HANDLERS =======

        // Start session
        btnStart.addEventListener("click", async () => {
            const now = Math.floor(Date.now() / 1000);

            await update(sessionRef, {
                status: "running",
                started_at: now,
                ended_at: null
            });
        });

        btnSaveThreshold.addEventListener("click", async () => {
            const t = {
                temp_min: Number(thTempMinEl.value),
                temp_max: Number(thTempMaxEl.value),
                moist_min: Number(thMoistMinEl.value),
                moist_max: Number(thMoistMaxEl.value)
            };

            await update(thresholdRef, t);
            alert("Threshold updated.");
        });


        // Stop session
        btnStop.addEventListener("click", async () => {
            const now = Math.floor(Date.now() / 1000);

            await update(sessionRef, {
                status: "stopped",
                ended_at: now
            });
        });

        // Generate Dummy Data – hanya kalau running
        btnDummy.addEventListener("click", async () => {
            if (currentStatus !== "running") {
                alert("Session belum running. Tekan Start dulu.");
                return;
            }

            const t = Math.floor(Date.now() / 1000);

            const data = {
                timestamp: t,
                temperature: 55 + Math.random() * 15,
                moisture: 40 + Math.round(Math.random() * 20),
                gas: 100 + Math.round(Math.random() * 80),
                ph: 7 + (Math.random() * 0.6 - 0.3),
                ec: 2 + (Math.random() * 0.5 - 0.25),
                maturity: 60 + Math.round(Math.random() * 20)
            };

            await set(ref(db, `sensor_logs/${SESSION_ID}/${t}`), data);
            await set(latestRef, data);
        });

        // Dummy Image – simulasi ESP32-CAM (hanya ketika running)
        btnDummyImage.addEventListener("click", async () => {
            if (currentStatus !== "running") {
                alert("Session belum running. Tekan Start dulu.");
                return;
            }

            const t = Math.floor(Date.now() / 1000);
            // Dummy URL pakai picsum (hanya buat testing)
            const url = `https://picsum.photos/seed/${t}/640/360`;

            await set(ref(db, `images/${SESSION_ID}/${t}`), {
                url,
                timestamp: t
            });
        });


        // ======= CHART REFRESH =======
        // Di bagian script index.html, ubah fungsi refreshChart:
        async function refreshChart() {
            const q = query(logsRef, orderByKey(), limitToLast(20));
            const snap = await get(q);

            const tMin = thresholds.temp_min ?? null;
            const tMax = thresholds.temp_max ?? null;
            const mMin = thresholds.moist_min ?? null;
            const mMax = thresholds.moist_max ?? null;

            if (!snap.exists()) {
                updateTempChart(tempChart, [], [], tMin, tMax);
                updateMoistChart(moistChart, [], [], mMin, mMax);
                return;
            }

            const labels = [];
            const temps = [];
            const moistures = [];

            snap.forEach((child) => {
                const v = child.val();
                labels.push(new Date(child.key * 1000).toLocaleTimeString());
                temps.push(v.temperature);
                moistures.push(v.moisture);
            });

            updateTempChart(tempChart, labels, temps, tMin, tMax);
            updateMoistChart(moistChart, labels, moistures, mMin, mMax);
        }



    </script>
</body>

</html>