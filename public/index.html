<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Kompos Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./style.css" />
</head>

<body>
    <div class="app-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Kompos<br>Dashboard</h1>
                <div class="session-control">
                    <select id="sessionSelect" class="session-select">
                        <option value="session_001" selected>session_001</option>
                    </select>
                    <button id="btnNewSession" class="btn-icon" title="New Session">+</button>
                    <button id="btnDeleteSession" class="btn-icon danger" title="Delete Session">√ó</button>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="section-title">
                    <h3>Control</h3>
                    <span id="sessionStatus" class="status-pill status-stopped">Stopped</span>
                </div>
                <div class="control-grid">
                    <button id="btnStart" class="btn-primary">Start</button>
                    <button id="btnStop" class="btn-secondary" disabled>Stop</button>
                    <button id="btnDummy" class="btn-ghost">Dummy Data</button>
                    <button id="btnDummyImage" class="btn-ghost">Dummy Cam</button>
                    <input type="file" id="camFile" accept="image/*" style="display:none" />
                    <button id="btnUploadTestImage" class="btn-ghost">Upload Img</button>
                    <button id="btnExportCSV" class="btn-ghost">Export CSV</button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Notifications</h3>
                <div class="form-group">
                    <label>WhatsApp Number (62...)</label>
                    <input id="waNumber" type="text" placeholder="628..."
                        style="width: 100%; padding: 5px; margin-bottom: 5px;" />
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="waEnabled" />
                    <label for="waEnabled" style="cursor: pointer;">Enable WA Alerts</label>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Thresholds</h3>
                <div class="threshold-form">
                    <div class="form-group">
                        <label>Temp (¬∞C)</label>
                        <div class="row">
                            <input id="thTempMin" type="number" placeholder="Min" />
                            <input id="thTempMax" type="number" placeholder="Max" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Moist (%)</label>
                        <div class="row">
                            <input id="thMoistMin" type="number" placeholder="Min" />
                            <input id="thMoistMax" type="number" placeholder="Max" />
                        </div>
                    </div>
                    <button id="btnSaveThreshold" class="btn-small">Save Settings</button>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- TOP BAR: SENSORS -->
            <header class="top-bar" id="currentCard">
                <div class="sensor-list">
                    <div class="sensor-pill temp">
                        <span class="icon">üå°Ô∏è</span>
                        <span class="value" id="temp">-</span>
                        <span class="unit">¬∞C</span>
                    </div>
                    <div class="sensor-pill moist">
                        <span class="icon">üíß</span>
                        <span class="value" id="moist">-</span>
                        <span class="unit">%</span>
                    </div>
                    <!-- Reuse/Rename slots for new data -->
                    <div class="sensor-pill">
                        <span class="label">Methane</span>
                        <span class="value" id="methane">-</span>
                    </div>
                    <div class="sensor-pill">
                        <span class="label">CO2</span>
                        <span class="value" id="co2">-</span>
                    </div>
                    <div class="sensor-pill">
                        <span class="label">Humidity</span>
                        <span class="value" id="humidity">-</span>
                        <span class="unit">%</span>
                    </div>
                    <!-- Removed Mat/Maturity as it is not in the new sensor list -->
                </div>
                <div class="meta-info">
                    <span id="lastUpdate">Waiting for data...</span>
                </div>
                <!-- Alerts Container -->
                <div id="tempAlert" class="alert-toast" style="display:none"></div>
                <div id="moistAlert" class="alert-toast" style="display:none"></div>
            </header>

            <!-- DASHBOARD GRID -->
            <div class="dashboard-layout">
                <div class="charts-area">
                    <div class="chart-box">
                        <canvas id="tempChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <canvas id="moistChart"></canvas>
                    </div>
                </div>

                <div class="camera-area">
                    <div class="camera-box">
                        <div class="cam-header">
                            <span>Live Feed</span>
                            <span id="imgTimestamp" class="time-badge">-</span>
                        </div>
                        <div class="cam-view">
                            <img id="compostImage" src="" alt="Live" />
                            <div id="imagePlaceholder" class="placeholder">No Signal</div>
                        </div>
                    </div>
                    <div class="history-box">
                        <div class="history-header">
                            <span>History</span>
                            <div class="nav">
                                <button id="imgPrev" disabled>&lt;</button>
                                <span id="imgPageLabel">1/1</span>
                                <button id="imgNext" disabled>&gt;</button>
                            </div>
                        </div>

                        <!-- DATA TABLE (HIDDEN) -->
                        <div class="data-table-box" style="display:none;">
                            <div class="table-header">
                                <h3>Sensor History</h3>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Time</th>
                                            <th>Temp (¬∞C)</th>
                                            <th>Moist (%)</th>
                                            <th>Gas</th>
                                            <th>pH</th>
                                            <th>EC</th>
                                            <th>Mat (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sensorTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="imageHistory" class="history-thumbs"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase + Logic -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getDatabase,
            ref,
            onValue,
            set,
            update,
            query,
            orderByKey,
            limitToLast,
            get,
            remove
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

        import {
            getStorage,
            ref as storageRef,
            uploadBytes,
            getDownloadURL
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";


        // Chart helper
        import {
            createTempChart,
            updateTempChart,
            createMoistChart,
            updateMoistChart
        } from "./tempChart.js";

        // Format number (fix float panjang)
        const fmt = (v, d = 1) => (v == null || isNaN(v) ? "-" : Number(v).toFixed(d));

        const DEFAULT_THRESHOLDS = {
            temp_min: 55,
            temp_max: 65,
            moist_min: 40,
            moist_max: 60,
        };
        // Threshold suhu maksimum (¬∞C)
        const thTempMinEl = document.getElementById("thTempMin");
        const thTempMaxEl = document.getElementById("thTempMax");
        const thMoistMinEl = document.getElementById("thMoistMin");
        const thMoistMaxEl = document.getElementById("thMoistMax");
        const btnSaveThreshold = document.getElementById("btnSaveThreshold");
        const fileInputCam = document.getElementById("camFile");
        const btnUploadTestImage = document.getElementById("btnUploadTestImage");



        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDJ_vVRBcNu9mBHeJY9L42rjH20IlxTLgw",
            authDomain: "compost-box.firebaseapp.com",
            databaseURL: "https://compost-box-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "compost-box",
            storageBucket: "compost-box.firebasestorage.app",
            messagingSenderId: "161024168281",
            appId: "1:161024168281:web:91fb7c6dd22fc7baf97c48",
            measurementId: "G-69FL0VCF5N"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // Global State
        let currentSessionId = "session_001";
        let currentStatus = "stopped";
        let thresholds = { ...DEFAULT_THRESHOLDS };
        let lastLatest = null;
        let lastWaSent = 0; // Timestamp for WA cooldown
        let waNumber = "";

        // Listener Unsubscribers
        let unsubSession, unsubLatest, unsubThreshold, unsubImages;

        // Firebase References (Dynamic)
        let latestRef, logsRef, sessionRef, imagesRef, thresholdRef;

        // DOM Elements
        const sessionSelect = document.getElementById("sessionSelect");
        const btnNewSession = document.getElementById("btnNewSession");
        const btnDeleteSession = document.getElementById("btnDeleteSession");
        const currentCard = document.getElementById("currentCard");
        const tempAlertEl = document.getElementById("tempAlert");
        const statusEl = document.getElementById("sessionStatus");
        const btnStart = document.getElementById("btnStart");
        const btnStop = document.getElementById("btnStop");
        const btnDummy = document.getElementById("btnDummy");
        const btnDummyImage = document.getElementById("btnDummyImage");
        const imgEl = document.getElementById("compostImage");
        const imgTimeEl = document.getElementById("imgTimestamp");
        const imgPlaceholderEl = document.getElementById("imagePlaceholder");
        const imageHistoryEl = document.getElementById("imageHistory");
        const imgPrevBtn = document.getElementById("imgPrev");
        const imgNextBtn = document.getElementById("imgNext");
        const imgPageLabel = document.getElementById("imgPageLabel");

        // state history for images
        let imageEntries = [];
        let imagePage = 0;
        const IMAGE_PAGE_SIZE = 6;

        // Charts
        const tempChart = createTempChart(
            document.getElementById("tempChart").getContext("2d")
        );
        const moistChart = createMoistChart(
            document.getElementById("moistChart").getContext("2d")
        );

        // Initialize Session Manager
        initSessionManager();

        async function initSessionManager() {
            // Populate Session Dropdown
            const allSessionsRef = ref(db, 'sessions');
            const snap = await get(allSessionsRef);

            sessionSelect.innerHTML = "";
            let foundLegacy = false;

            if (snap.exists()) {
                const data = snap.val();
                Object.keys(data).forEach(key => {
                    const opt = document.createElement("option");
                    opt.value = key;
                    opt.textContent = key;
                    sessionSelect.appendChild(opt);
                    if (key === "session_001") foundLegacy = true;
                });
            }

            // Fallback if empty or session_001 missing (create it)
            if (sessionSelect.options.length === 0 || !foundLegacy) {
                if (!foundLegacy) {
                    const opt = document.createElement("option");
                    opt.value = "session_001";
                    opt.textContent = "session_001";
                    sessionSelect.appendChild(opt);
                }
            }

            // Set initial value
            sessionSelect.value = currentSessionId;
            loadSession(currentSessionId);

            // Events
            sessionSelect.addEventListener("change", (e) => {
                loadSession(e.target.value);
            });

            btnNewSession.addEventListener("click", () => {
                const name = prompt("Enter new session name (alphanumeric, no spaces):", `Session_${Math.floor(Date.now() / 1000)}`);
                if (name && name.trim() !== "") {
                    // Sanitize key
                    const cleanName = name.trim().replace(/[.#$/[\]\s]/g, "_");

                    // Add to dropdown if not exists
                    let exists = false;
                    for (let i = 0; i < sessionSelect.options.length; i++) {
                        if (sessionSelect.options[i].value === cleanName) exists = true;
                    }

                    if (!exists) {
                        const opt = document.createElement("option");
                        opt.value = cleanName;
                        opt.textContent = cleanName;
                        sessionSelect.appendChild(opt);
                    }

                    sessionSelect.value = cleanName;
                    loadSession(cleanName);
                }
            });

            btnDeleteSession.addEventListener("click", async () => {
                const sid = currentSessionId;
                if (!sid) return;

                if (confirm(`Are you sure you want to DELETE sessions "${sid}" and all its data? This cannot be undone.`)) {
                    try {
                        // 1. Remove from all paths
                        await remove(ref(db, `latest/${sid}`));
                        await remove(ref(db, `sensor_logs/${sid}`));
                        await remove(ref(db, `sessions/${sid}`)); // This removes metadata & thresholds
                        await remove(ref(db, `images/${sid}`));

                        alert(`Session "${sid}" deleted.`);

                        // 2. Remove from dropdown
                        let indexToRemove = -1;
                        for (let i = 0; i < sessionSelect.options.length; i++) {
                            if (sessionSelect.options[i].value === sid) {
                                indexToRemove = i;
                                break;
                            }
                        }
                        if (indexToRemove !== -1) {
                            sessionSelect.remove(indexToRemove);
                        }

                        // 3. Switch to another session
                        if (sessionSelect.options.length > 0) {
                            sessionSelect.selectedIndex = 0;
                            loadSession(sessionSelect.value);
                        } else {
                            // If no sessions left, create default
                            const opt = document.createElement("option");
                            opt.value = "session_001";
                            opt.textContent = "session_001";
                            sessionSelect.appendChild(opt);
                            sessionSelect.value = "session_001";
                            loadSession("session_001");
                        }

                    } catch (err) {
                        console.error("Delete failed", err);
                        alert("Failed to delete session. See console.");
                    }
                }
            });
        }

        function loadSession(sid) {
            console.log("Switching to session:", sid);
            currentSessionId = sid;

            // Detach old listeners
            if (unsubSession) unsubSession();
            if (unsubThreshold) unsubThreshold();
            if (unsubLatest) unsubLatest();
            if (unsubImages) unsubImages();

            // Clear UI
            document.getElementById("temp").textContent = "-";
            document.getElementById("moist").textContent = "-";
            document.getElementById("methane").textContent = "-";
            document.getElementById("co2").textContent = "-";
            document.getElementById("humidity").textContent = "-";
            // document.getElementById("maturity").textContent = "-";
            document.getElementById("lastUpdate").textContent = "Waiting for data...";
            imgEl.style.display = "none";
            imgPlaceholderEl.style.display = "block";
            imageHistoryEl.innerHTML = "";

            // Re-define Refs
            latestRef = ref(db, `latest`);
            logsRef = ref(db, `sensor_logs/${sid}`);
            sessionRef = ref(db, `sessions/${sid}`);
            imagesRef = ref(db, `images/${sid}`);
            thresholdRef = ref(db, `sessions/${sid}/threshold`);

            // Attach Listeners
            subscribeToSession();

            // Refresh Charts manually
            refreshChart();
        }

        function subscribeToSession() {
            // 1. Session Status
            unsubSession = onValue(sessionRef, async (snap) => {
                let data = snap.val();
                if (!data) {
                    const now = Math.floor(Date.now() / 1000);
                    data = { status: "stopped", started_at: null, ended_at: now };
                    await set(sessionRef, data);
                }
                currentStatus = data.status || "stopped";
                updateSessionUI();
            });

            // 2. Thresholds
            unsubThreshold = onValue(thresholdRef, async (snap) => {
                let t = snap.val();
                if (!t) {
                    await update(thresholdRef, DEFAULT_THRESHOLDS);
                    t = DEFAULT_THRESHOLDS;
                }
                thresholds = { ...DEFAULT_THRESHOLDS, ...t };

                // Update Inputs
                thTempMinEl.value = thresholds.temp_min;
                thTempMaxEl.value = thresholds.temp_max;
                thMoistMinEl.value = thresholds.moist_min;
                thMoistMaxEl.value = thresholds.moist_max;

                if (thresholds.wa_number) document.getElementById("waNumber").value = thresholds.wa_number;
                if (thresholds.wa_enabled !== undefined) document.getElementById("waEnabled").checked = thresholds.wa_enabled;

                applyTempAlert();
                refreshChart();
            });

            // 3. Latest Sensor Data
            // 3. Latest Sensor Data (NEW AVG LOGIC)
            unsubLatest = onValue(latestRef, (snap) => {
                const d = snap.val();
                if (!d) return;

                // d should be { sensor1: {...}, sensor2: {...}, sensor3: {...}, ... }
                // Calculate averages
                let sumTemp = 0, sumMoist = 0, sumMethane = 0, sumCO2 = 0, sumHum = 0;
                let count = 0;
                let latestTs = 0;

                // Iterate over keys that start with "sensor"
                Object.keys(d).forEach(k => {
                    if (k.startsWith("sensor")) {
                        const s = d[k];
                        if (s) {
                            count++;
                            sumTemp += Number(s.temperature || 0);
                            sumMoist += Number(s.moisture || 0);
                            sumMethane += Number(s.methane || 0);
                            sumCO2 += Number(s.co2 || 0);
                            sumHum += Number(s.humidity || 0);
                            // Track latest timestamp
                            if (s.timestamp && s.timestamp > latestTs) latestTs = s.timestamp;
                        }
                    }
                });

                if (count > 0) {
                    const avgTemp = sumTemp / count;
                    const avgMoist = sumMoist / count;
                    const avgMethane = sumMethane / count;
                    const avgCO2 = sumCO2 / count;
                    const avgHum = sumHum / count;

                    lastLatest = {
                        temperature: avgTemp,
                        moisture: avgMoist,
                        timestamp: latestTs
                    };

                    document.getElementById("temp").textContent = fmt(avgTemp, 1);
                    document.getElementById("moist").textContent = fmt(avgMoist, 0);
                    document.getElementById("methane").textContent = fmt(avgMethane, 0);
                    document.getElementById("co2").textContent = fmt(avgCO2, 0);
                    document.getElementById("humidity").textContent = fmt(avgHum, 0);
                    // document.getElementById("maturity").textContent = "-"; // specific maturity not in new list

                    if (latestTs) {
                        document.getElementById("lastUpdate").textContent =
                            new Date(latestTs * 1000).toLocaleString();
                    }
                }

                applyTempAlert();
                refreshChart(); // Update chart with logs if available
            });

            // 4. Images
            unsubImages = onValue(imagesRef, (snap) => {
                const data = snap.val();
                if (!data) {
                    imgEl.style.display = "none";
                    imgPlaceholderEl.style.display = "block";
                    imgTimeEl.textContent = "-";
                    imageHistoryEl.innerHTML = "";
                    imageEntries = [];
                    renderImageHistory();
                    return;
                }

                const entries = Object.entries(data)
                    .map(([k, v]) => [Number(k), v])
                    .filter(([ts, v]) => v && v.url)
                    .sort((a, b) => b[0] - a[0]);

                imageEntries = entries;

                // Latest Image
                if (entries.length > 0) {
                    const [latestTs, latestInfo] = entries[0];
                    imgEl.src = latestInfo.url;
                    imgEl.style.display = "block";
                    imgPlaceholderEl.style.display = "none";
                    const t = latestInfo.timestamp || latestTs;
                    imgTimeEl.textContent = t ? new Date(t * 1000).toLocaleString() : "-";
                } else {
                    imgEl.style.display = "none";
                    imgPlaceholderEl.style.display = "block";
                }

                imagePage = 0;
                renderImageHistory();
            });
        }

        function updateSessionUI() {
            statusEl.textContent = currentStatus === "running" ? "Running" : "Stopped";
            statusEl.classList.remove("status-running", "status-stopped");
            statusEl.classList.add(currentStatus === "running" ? "status-running" : "status-stopped");

            btnStart.disabled = (currentStatus === "running");
            btnStop.disabled = (currentStatus !== "running");
        }

        function applyTempAlert() {
            if (!lastLatest) return;
            const tempVal = Number(lastLatest.temperature);
            const moistVal = Number(lastLatest.moisture);
            const { temp_min, temp_max, moist_min, moist_max } = thresholds;
            const tempAlertEl = document.getElementById("tempAlert");
            const moistAlertEl = document.getElementById("moistAlert");

            if (!isNaN(tempVal) && (tempVal < temp_min || tempVal > temp_max)) {
                tempAlertEl.textContent = `‚ö†Ô∏è Temperature ${fmt(tempVal, 1)} ¬∞C outside range ${temp_min}‚Äì${temp_max} ¬∞C.`;
                tempAlertEl.style.display = "block";
                tempAlertEl.style.color = "#ff4d4f";
            } else {
                tempAlertEl.style.display = "none";
            }

            if (!isNaN(moistVal) && (moistVal < moist_min || moistVal > moist_max)) {
                moistAlertEl.textContent = `‚ö†Ô∏è Moisture ${fmt(moistVal, 0)}% outside range ${moist_min}‚Äì${moist_max}%.`;
                moistAlertEl.style.display = "block";
                moistAlertEl.style.color = "#ffa940";
            } else {
                moistAlertEl.style.display = "none";
            }

            if (currentCard) {
                if ((tempAlertEl.style.display === "block") || (moistAlertEl.style.display === "block")) {
                    currentCard.classList.add("card-alert");

                    // Check WA Alert
                    const activeAlerts = [];
                    if (tempAlertEl.style.display === "block") activeAlerts.push(tempAlertEl.textContent);
                    if (moistAlertEl.style.display === "block") activeAlerts.push(moistAlertEl.textContent);

                    checkAndSendWA(activeAlerts.join("\n"));
                } else {
                    currentCard.classList.remove("card-alert");
                }
            }
        }

        function checkAndSendWA(message) {
            const enabled = document.getElementById("waEnabled").checked;
            const number = document.getElementById("waNumber").value;
            const now = Math.floor(Date.now() / 1000);
            const cooldown = 300; // 5 minutes

            if (!enabled || !number || message.length === 0) return;

            if (now - lastWaSent > cooldown) {
                console.log("Sending WA Alert:", message);
                lastWaSent = now;

                // Format message
                const text = `*KOMPOS ALERT*\n${message}\nTime: ${new Date().toLocaleString()}`;
                const url = `https://wa.me/${number}?text=${encodeURIComponent(text)}`;

                // Try to open window
                const win = window.open(url, '_blank');
                if (win) {
                    // Success
                } else {
                    // Blocked
                    console.warn("WA Popup blocked");
                    // alert("WA Alert blocked by browser. Please allow popups.");
                }
            }
        }

        function renderImageHistory() {
            if (!imageHistoryEl) return;
            imageHistoryEl.innerHTML = "";

            if (!imageEntries || imageEntries.length === 0) {
                for (let i = 0; i < IMAGE_PAGE_SIZE; i++) {
                    const emptyDiv = document.createElement("div");
                    emptyDiv.className = "image-history-item empty";
                    emptyDiv.textContent = "No Image";
                    imageHistoryEl.appendChild(emptyDiv);
                }
                if (imgPageLabel) imgPageLabel.textContent = "Page 0 / 0";
                if (imgPrevBtn) imgPrevBtn.disabled = true;
                if (imgNextBtn) imgNextBtn.disabled = true;
                return;
            }

            const totalPages = Math.ceil(imageEntries.length / IMAGE_PAGE_SIZE);
            if (imagePage >= totalPages) imagePage = totalPages - 1;
            if (imagePage < 0) imagePage = 0;

            const start = imagePage * IMAGE_PAGE_SIZE;
            const end = start + IMAGE_PAGE_SIZE;
            const pageItems = imageEntries.slice(start, end);

            pageItems.forEach(([ts, item]) => {
                if (!item || !item.url) return;
                const t = item.timestamp || ts;
                const timeStr = t ? new Date(t * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : String(ts);

                const div = document.createElement("div");
                div.className = "image-history-item";

                const imgContainer = document.createElement("div");
                imgContainer.className = "image-history-img-container";
                const img = document.createElement("img");
                img.src = item.url;
                img.alt = `Compost ${timeStr}`;
                img.loading = "lazy";
                imgContainer.appendChild(img);

                const meta = document.createElement("div");
                meta.className = "image-history-meta";
                meta.textContent = timeStr;

                div.appendChild(imgContainer);
                div.appendChild(meta);

                div.addEventListener("click", () => {
                    imgEl.src = item.url;
                    imgEl.style.display = "block";
                    imgPlaceholderEl.style.display = "none";
                    if (t) imgTimeEl.textContent = new Date(t * 1000).toLocaleString();
                });

                imageHistoryEl.appendChild(div);
            });

            const remainingSlots = IMAGE_PAGE_SIZE - pageItems.length;
            for (let i = 0; i < remainingSlots; i++) {
                const emptyDiv = document.createElement("div");
                emptyDiv.className = "image-history-item empty";
                emptyDiv.textContent = "Empty";
                imageHistoryEl.appendChild(emptyDiv);
            }

            if (imgPageLabel) imgPageLabel.textContent = `Page ${imagePage + 1} / ${totalPages}`;
            if (imgPrevBtn) imgPrevBtn.disabled = imagePage === 0;
            if (imgNextBtn) imgNextBtn.disabled = imagePage >= totalPages - 1;
        }

        if (imgPrevBtn) imgPrevBtn.addEventListener("click", () => {
            if (imagePage > 0) { imagePage--; renderImageHistory(); }
        });
        if (imgNextBtn) imgNextBtn.addEventListener("click", () => {
            const totalPages = Math.ceil(imageEntries.length / IMAGE_PAGE_SIZE);
            if (imagePage < totalPages - 1) { imagePage++; renderImageHistory(); }
        });

        // ======= BUTTON HANDLERS =======
        btnStart.addEventListener("click", async () => {
            console.log("Btn Start Clicked");
            try {
                if (!sessionRef) {
                    throw new Error("Session Ref is missing");
                }
                const now = Math.floor(Date.now() / 1000);
                console.log("Updating session status to running...");
                await update(sessionRef, { status: "running", started_at: now, ended_at: null });
                console.log("Session status updated.");
            } catch (err) {
                console.error("Start Error:", err);
                alert("Error starting session: " + err.message);
            }
        });

        btnStop.addEventListener("click", async () => {
            const now = Math.floor(Date.now() / 1000);
            await update(sessionRef, { status: "stopped", ended_at: now });
        });

        btnSaveThreshold.addEventListener("click", async () => {
            const t = {
                temp_min: Number(thTempMinEl.value),
                temp_max: Number(thTempMaxEl.value),
                moist_min: Number(thMoistMinEl.value),
                moist_max: Number(thMoistMaxEl.value),
                wa_number: document.getElementById("waNumber").value,
                wa_enabled: document.getElementById("waEnabled").checked
            };
            await update(thresholdRef, t);
            alert("Settings updated for " + currentSessionId);
        });

        btnDummy.addEventListener("click", async () => {
            if (currentStatus !== "running") { alert("Session belum running. Tekan Start dulu."); return; }
            const t = Math.floor(Date.now() / 1000);

            // Generate dummy 3 sensors
            const sensors = {};
            let sumTemp = 0, sumMoist = 0, sumMethane = 0, sumCO2 = 0, sumHum = 0;
            const count = 3;

            for (let i = 1; i <= count; i++) {
                const temp = 55 + Math.random() * 15;
                const moist = 40 + Math.round(Math.random() * 20);
                const meth = 10 + Math.round(Math.random() * 20);
                const co2 = 400 + Math.round(Math.random() * 100);
                const hum = 60 + Math.round(Math.random() * 20);

                sumTemp += temp;
                sumMoist += moist;
                sumMethane += meth;
                sumCO2 += co2;
                sumHum += hum;

                sensors[`sensor${i}`] = {
                    timestamp: t,
                    temperature: temp,
                    moisture: moist,
                    methane: meth,
                    co2: co2,
                    humidity: hum
                };
            }

            // Write to latest (root)
            await set(latestRef, sensors);

            // Calculate averages for LOGS so Chart/Table updates
            const avgData = {
                timestamp: t,
                temperature: sumTemp / count,
                moisture: sumMoist / count,
                methane: sumMethane / count,
                co2: sumCO2 / count,
                humidity: sumHum / count
                // maturity removed
            };

            await set(ref(db, `sensor_logs/${currentSessionId}/${t}`), avgData);
        });

        btnDummyImage.addEventListener("click", async () => {
            if (currentStatus !== "running") { alert("Session belum running. Tekan Start dulu."); return; }
            const t = Math.floor(Date.now() / 1000);
            const url = `https://picsum.photos/seed/${t}/640/360`;
            await set(ref(db, `images/${currentSessionId}/${t}`), { url, timestamp: t });
        });

        btnUploadTestImage.addEventListener("click", () => { fileInputCam.click(); });

        fileInputCam.addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (currentStatus !== "running") {
                alert("Session belum running. Tekan Start dulu.");
                fileInputCam.value = "";
                return;
            }
            try {
                const t = Math.floor(Date.now() / 1000);
                const path = `images/${currentSessionId}/${t}_${file.name}`;
                const sRef = storageRef(storage, path);
                await uploadBytes(sRef, file);
                const url = await getDownloadURL(sRef);
                await set(ref(db, `images/${currentSessionId}/${t}`), { url, timestamp: t });
                fileInputCam.value = "";
            } catch (err) {
                console.error("Upload error:", err);
                alert("Gagal upload gambar.");
            }
        });

        async function refreshChart() {
            if (!logsRef) return;
            // Fetch more logs for table
            const q = query(logsRef, orderByKey(), limitToLast(50));
            const snap = await get(q);

            const tMin = thresholds.temp_min ?? null;
            const tMax = thresholds.temp_max ?? null;
            const mMin = thresholds.moist_min ?? null;
            const mMax = thresholds.moist_max ?? null;

            if (!snap.exists()) {
                updateTempChart(tempChart, [], [], tMin, tMax);
                updateMoistChart(moistChart, [], [], mMin, mMax);
                renderTable([]);
                return;
            }

            const chartLimit = 20; // Only show last 20 on chart

            const allData = [];
            snap.forEach((child) => {
                const k = child.key;
                const v = child.val();
                allData.push({ k, ...v });
            });

            // Update Chart (Last 20)
            const chartData = allData.slice(-chartLimit);
            const labels = chartData.map(d => new Date(d.k * 1000).toLocaleTimeString());
            const temps = chartData.map(d => d.temperature);
            const moistures = chartData.map(d => d.moisture);

            updateTempChart(tempChart, labels, temps, tMin, tMax);
            updateMoistChart(moistChart, labels, moistures, mMin, mMax);

            // Update Table (All 50, reversed for newest first)
            renderTable([...allData].reverse());
        }

        const sensorTableBody = document.getElementById("sensorTableBody");
        function renderTable(dataList) {
            sensorTableBody.innerHTML = "";
            dataList.forEach(d => {
                const tr = document.createElement("tr");
                const timeStr = new Date(d.k * 1000).toLocaleString();

                tr.innerHTML = `
                    <td class="cell-time">${timeStr}</td>
                    <td>${fmt(d.temperature, 1)}</td>
                    <td>${fmt(d.moisture, 0)}</td>
                    <td>${fmt(d.gas, 0)}</td>
                    <td>${fmt(d.ph, 2)}</td>
                    <td>${fmt(d.ec, 2)}</td>
                    <td>${fmt(d.maturity, 0)}</td>
                `;
                sensorTableBody.appendChild(tr);
            });
        }

        const btnExportCSV = document.getElementById("btnExportCSV");
        btnExportCSV.addEventListener("click", async () => {
            if (!logsRef) return;
            // Download all data for session (not just last 50)
            const snap = await get(query(logsRef, orderByKey()));
            if (!snap.exists()) {
                alert("No data to export.");
                return;
            }

            let csv = "Timestamp,Date,Time,Temperature,Moisture,Gas,pH,EC,Maturity\n";
            snap.forEach(child => {
                const v = child.val();
                const ts = child.key * 1000;
                const d = new Date(ts);
                csv += `${ts},${d.toLocaleDateString()},${d.toLocaleTimeString()},${v.temperature},${v.moisture},${v.gas},${v.ph},${v.ec},${v.maturity}\n`;
            });

            const blob = new Blob([csv], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `kompos_session_${currentSessionId}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        });



    </script>
</body>

</html>